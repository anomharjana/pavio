<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <title>Dotmap CSV Indonesia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

</head>

<body class="bg-gray-100 flex flex-col items-center">

  <div class="container max-w-4xl w-full p-6 mt-10 bg-white shadow-lg rounded-lg">

    <h2 class="text-2xl text-center font-semibold text-gray-800 mb-4">Upload CSV dan Tampilkan Dotmap (Peta Kasus)</h2>

    <input type="file" id="csvFile" accept=".csv" class="px-4 py-2 border rounded-lg mb-4 w-full bg-gray-100" />
    <button id="showMapBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 w-full" disabled>Tampilkan Titik</button>
    <div id="status" class="mt-3 text-gray-600">Silakan upload file CSV berisi latitude & longitude.</div>

    <!-- Dropdown untuk memilih kolom yang akan divisualisasikan -->
    <div id="interpretation" class="mt-6 hidden">
      <h3 class="text-xl font-semibold text-gray-700">Pilih Variabel untuk Interpretasi:</h3>
      <div class="variable-selector mt-2">
        <select id="columnSelect" class="px-4 py-2 border rounded-lg bg-gray-100 w-full">
          <option value="" disabled selected>Pilih Kolom untuk Interpretasi</option>
        </select>
      </div>
      <div id="summary" class="mt-4 text-gray-700"></div>
    </div>

    <!-- Peta -->
    <div id="map" class="mt-6 rounded-lg border" style="height: 400px;"></div>

  </div>

  <script>
    // Inisialisasi tile layer untuk OpenStreetMap
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    });

    // Inisialisasi tile layer untuk Satellite (ESRI)
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/' +
      'World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    });

    // Inisialisasi peta dengan OSM sebagai default
    const map = L.map('map', {
      center: [-2.5, 118],
      zoom: 5,
      layers: [osmLayer] // default layer
    });

    // Control untuk ganti layer
    const baseMaps = {
      "OpenStreetMap": osmLayer,
      "Satellite": satelliteLayer
    };
    L.control.layers(baseMaps).addTo(map);

    let parsedData = [];
    let latKey, lonKey;
    let selectedColumn;

    // Fungsi deteksi kolom latitude/longitude
    function detectLatLonFields(headers) {
      const latCandidates = ['lat', 'latitude', 'Latitude', 'LAT'];
      const lonCandidates = ['lon', 'lng', 'long', 'longitude', 'Longitude', 'LON', 'LNG'];

      let lat = null, lon = null;

      for (const key of headers) {
        const lower = key.toLowerCase();
        if (!lat && latCandidates.includes(lower)) lat = key;
        if (!lon && lonCandidates.includes(lower)) lon = key;
      }

      return { latKey: lat, lonKey: lon };
    }

    // Fungsi untuk menganalisis data numerik atau kategorikal
    function analyzeColumn(data, column) {
      const values = data.map(row => row[column]);
      const isNumeric = values.every(value => !isNaN(value));

      if (isNumeric) {
        const numericValues = values.map(Number);
        const min = Math.min(...numericValues);
        const max = Math.max(...numericValues);
        const mean = (numericValues.reduce((acc, val) => acc + val, 0) / numericValues.length).toFixed(2);
        return `Min: ${min}, Max: ${max}, Rata-rata: ${mean}`;
      } else {
        const freqMap = {};
        values.forEach(value => freqMap[value] = (freqMap[value] || 0) + 1);
        const freqSummary = Object.entries(freqMap).map(([key, val]) => `${key}: ${val}`).join(', ');
        return `Frekuensi: ${freqSummary}`;
      }
    }

    // Fungsi untuk mendapatkan warna berdasarkan kategori
    function getCategoryColor(value, categories) {
      const colors = ['#FF5733', '#33FF57', '#3357FF', '#FF33A1', '#A1FF33', '#33FFF0'];
      const categoryIndex = categories.indexOf(value);
      return colors[categoryIndex % colors.length];
    }

    // Fungsi untuk menampilkan legenda
    function updateLegend(categories) {
      // Menghapus legenda lama jika ada
      const existingLegend = document.querySelector('.legend');
      if (existingLegend) {
        existingLegend.remove();
      }

      const legendDiv = document.createElement('div');
      legendDiv.className = 'legend absolute bottom-2 left-2 bg-white p-3 rounded-lg shadow-md';
      let legendHTML = '<strong>Legenda:</strong><br>';

      categories.forEach((category, index) => {
        const color = getCategoryColor(category, categories);
        legendHTML += `<i style="background:${color};" class="inline-block w-4 h-4 rounded-full mr-2"></i> ${category}<br>`;
      });

      legendDiv.innerHTML = legendHTML;
      document.body.appendChild(legendDiv);
    }

    document.getElementById('csvFile').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      document.getElementById('status').textContent = "Memproses file...";

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          const headers = results.meta.fields;
          const detected = detectLatLonFields(headers);

          if (!detected.latKey || !detected.lonKey) {
            document.getElementById('status').textContent = "Kolom latitude/longitude tidak ditemukan.";
            return;
          }

          latKey = detected.latKey;
          lonKey = detected.lonKey;

          parsedData = results.data.filter(row => {
            const lat = parseFloat(row[latKey]);
            const lon = parseFloat(row[lonKey]);
            return !isNaN(lat) && !isNaN(lon);
          });

          if (parsedData.length > 0) {
            document.getElementById('showMapBtn').disabled = false;
            document.getElementById('status').textContent = `Berhasil memuat ${parsedData.length} titik. Klik "Tampilkan Titik".`;

            // Menampilkan dropdown untuk memilih kolom lain
            const columns = Object.keys(results.data[0]);
            const selectElement = document.getElementById('columnSelect');
            columns.forEach(col => {
              if (col !== latKey && col !== lonKey) {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                selectElement.appendChild(option);
              }
            });

            // Menampilkan bagian interpretasi
            document.getElementById('interpretation').style.display = 'block';

            // Mendengarkan perubahan pilihan kolom
            selectElement.addEventListener('change', function () {
              selectedColumn = this.value;
              const interpretation = analyzeColumn(parsedData, selectedColumn);
              document.getElementById('summary').textContent = interpretation;

              // Mengupdate titik pada peta dengan warna berdasarkan kategori
              updateMapWithColor(selectedColumn);
            });

          } else {
            document.getElementById('status').textContent = "Tidak ada titik valid yang ditemukan.";
          }
        }
      });
    });

    // Fungsi untuk menampilkan titik pada peta dengan warna berdasarkan kategori
    function updateMapWithColor(column) {
      // Menghapus layer lama
      map.eachLayer(layer => {
        if (layer instanceof L.Marker) {
          map.removeLayer(layer);
        }
      });

      const categories = [...new Set(parsedData.map(row => row[column]))];  // Menyaring kategori unik
      updateLegend(categories);  // Memperbarui legenda dengan kategori baru

      const bounds = [];

      parsedData.forEach(row => {
        const lat = parseFloat(row[latKey]);
        const lon = parseFloat(row[lonKey]);
        if (!isNaN(lat) && !isNaN(lon)) {
          const marker = L.circleMarker([lat, lon], {
            radius: 5,
            fillColor: getCategoryColor(row[column], categories),
            color: "#fff",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.85
          }).bindPopup(`Lat: ${lat}<br>Lon: ${lon}`).addTo(map);

          bounds.push([lat, lon]);
        }
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [20, 20] });
        document.getElementById('status').textContent = "Titik berhasil ditampilkan dan peta disesuaikan.";
      } else {
        document.getElementById('status').textContent = "Tidak ada titik valid untuk ditampilkan.";
      }

      this.disabled = true;
    }

    document.getElementById('showMapBtn').addEventListener('click', function () {
      const selectedColumn = document.getElementById('columnSelect').value;
      updateMapWithColor(selectedColumn);
    });
  </script>
</body>

<footer>
    &copy; 2025 Pavio. Seluruh hak cipta dilindungi. 
  </footer>
  
</html>
